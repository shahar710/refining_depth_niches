---
title: "code"
author: "Shahar Chaikin"
date: "2024-10-24"
output: html_document
---
In this code I will provide measures of fish species depth range (1) and depth niche (2) in both the Red Sea and Mediterranean Sea. The overarching goal is to provide a refined information regarding species depths and compare to current knowledge available in FishBase.

Libraries
```{r}
library(tidyverse)
library(eHOF)
library(rfishbase)
```

#Data
```{r}
data_bruvs=read.csv("C:\\Users\\User\\Desktop\\research\\phd\\projects\\invasiveness_red_med\\project_folders\\data_wrangling_clean_output\\med_red_MaxN_data.csv")
```

Extract raw depth ranges using BRUVs data per sea
```{r}
bruvs_raw_depth=data_bruvs %>% 
  group_by(sea,species) %>% 
  summarise(min_depth=min(depth),
            max_depth=max(depth),
            occ=n()) %>% 
  filter(occ>1)
```

Extract fishbase depths
```{r}
#Species list to be used
sp_list=data_bruvs %>% 
  distinct(species) %>% 
  separate_wider_delim(species, delim = " ", names = c("Genus", "Species"),cols_remove = F) %>% 
  left_join(fb_tbl(tbl="species") %>% #Extracting the FishBase SpecCode of the species
              select(SpecCode,Genus,Species),by = c("Genus","Species"))

##Add some code manually for species with NAs
t_grabata=8969
T_erythraeensis="No records"
C_fulvoguttatus=1926
C_dimidiata=11861

sp_list=sp_list %>% 
  mutate(SpecCode=case_when(
    species%in%"Taeniura grabata"~t_grabata,
    #species%in%"Thamnaconus erythraeensis"~T_erythraeensis,
    species%in%"Carangoides fulvoguttatus"~C_fulvoguttatus,
    species%in%"Chromis dimidiata"~C_dimidiata,
    TRUE~SpecCode)) %>% 
  left_join(fb_tbl(tbl="species") %>% #update sp_names by FB
              select(SpecCode,fb_Genus=Genus,fb_Species=Species),
            by = c("SpecCode")) %>% 
  mutate(fb_Genus=case_when(
    Genus%in%"Thamnaconus"~"Thamnaconus",
                            TRUE~fb_Genus),
         fb_Species=case_when(
           Species%in%"erythraeensis"~"erythraeensis",
                            TRUE~fb_Species),
    fb_species_binom=paste(fb_Genus,fb_Species),
    updated_name=fb_species_binom==species)


#Update names in bruvs data as well
bruvs_raw_depth=bruvs_raw_depth %>% 
  left_join(sp_list %>%
              select(species,fb_species_binom),
            by="species")
```

#Use the above sp_list to extract depth info from FishBase
```{r}
fishbase_depths=estimate(species_list = sp_list$fb_species_binom,fields = c("SpecCode","ComDepthMin","ComDepthMax","ComDepMinObserved","ComDepMaxObserved","DepthMin","DepthMax","DepthMinEstimate","DepthMaxEstimate")) %>% 
  left_join(sp_list %>% select(SpecCode,species=fb_species_binom),
            by="SpecCode") %>% 
  relocate(last_col())
```

#Raw depth estimates
Combine raw depths with FishBase information
```{r}
bruvs_raw_vs_fishbase=bruvs_raw_depth %>% 
  left_join(fishbase_depths, by="fb_species_binom") %>% 
  mutate(novel_min_depth=case_when(min_depth<DepthMin~"yes",
                                   TRUE ~"no"),
         novel_max_depth=case_when(max_depth>DepthMax~"yes",
                                   TRUE ~"no"),
         either_min_max=case_when(
      novel_min_depth == "yes" | novel_max_depth == "yes" ~ "yes",
      TRUE ~ "no"),
      max_depth_diff=max_depth-DepthMax)
```

Plot it
```{r}
#Mediterranean Sea
med_p=ggplot(bruvs_raw_vs_fishbase %>% 
         filter(either_min_max%in%"yes",
                sea%in%"med"))+
  geom_linerange(aes(y=reorder(fb_species_binom,max_depth_diff),
                     xmin=min_depth,
                     xmax=max_depth),
                 color="blue",
                 size=2.5)+
  geom_linerange(aes(y=reorder(fb_species_binom,max_depth_diff),
                     xmin=DepthMin,
                     xmax=DepthMax),
                 color="grey",
                 size=1.2)+
  labs(title="A) Mediterranean Sea",x="Depth (m)",y="Species")+
  theme_bw()+
  theme(axis.text.y = element_text(face = "italic"))+
  coord_cartesian(xlim=c(0,200))

#Red Sea
red_p=ggplot(bruvs_raw_vs_fishbase %>% 
         filter(either_min_max%in%"yes",
                sea%in%"red"))+
  geom_linerange(aes(y=reorder(fb_species_binom,max_depth_diff),
                     xmin=min_depth,
                     xmax=max_depth),
                 color="red",
                 size=2.5)+
  geom_linerange(aes(y=reorder(fb_species_binom,max_depth_diff),
                     xmin=DepthMin,
                     xmax=DepthMax),
                 color="grey",
                 size=1.2)+
  labs(title="A) Red Sea",x="Depth (m)",y="Species")+
  theme_bw()+
  theme(axis.text.y = element_text(face = "italic"))+
  coord_cartesian(xlim=c(0,200))
```

Combine two plots
```{r}
both_seas_raw_p=
  gridExtra::grid.arrange(left="Species",
                          bottom="Depth (m)",
                          med_p+
                            theme(
                              axis.title.x = element_blank(),
                              axis.title.y = element_blank()),
                          red_p+
                            theme(
                              axis.title.x = element_blank(),
                              axis.title.y = element_blank()),
                        ncol = 1,layout_matrix = rbind(c(1),
                                                       c(2),
                                                       c(2),
                                                       c(2)))
ggsave(plot = both_seas_raw_p, filename = "both_seas_raw_p.png",device ="jpeg",height = 30,width = 20, units = "cm",dpi = 600)
```

#Central depth niches
##Get the rae data prepared for modelling with zeros
```{r}
#Mediterranean Sea
data_bruvs_with_zeros_med=data_bruvs %>% 
  filter(sea%in%"med") %>% 
  select(OpCode,
         species,
         MaxN) %>% 
  spread(key = species,
         value = MaxN,
         fill = 0) %>% 
  gather(key = species,value = MaxN,2:71) %>% 
  left_join(data_bruvs %>% 
              distinct(OpCode,sea,depth),
            by="OpCode")
#Red Sea
data_bruvs_with_zeros_red=data_bruvs %>% 
  filter(sea%in%"red") %>% 
  select(OpCode,
         species,
         MaxN) %>% 
  spread(key = species,
         value = MaxN,
         fill = 0) %>% 
  gather(key = species,value = MaxN,2:174) %>% 
  left_join(data_bruvs %>% 
              distinct(OpCode,sea,depth),
            by="OpCode")
```

